<%- include('../layouts/dashboard-layout-start', { title: title, section: 'blogs' }) %>
<div class="d-flex justify-content-between align-items-center mb-4">
  <h4 class="fw-bold text-success mb-0"><i class="fas fa-blog me-2"></i>Gestion des Blogs</h4>
  <button class="btn btn-sm btn-success" data-bs-toggle="collapse" data-bs-target="#newBlogForm"><i class="fas fa-plus me-1"></i>Nouvel article</button>
</div>

<div class="collapse mb-4" id="newBlogForm">
  <div class="card border-0 shadow-sm" style="border-radius:18px;">
    <div class="card-body">
      <form id="form-create-blog" class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label small fw-semibold">Titre *</label>
          <input type="text" name="title" class="form-control" required>
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label small fw-semibold">Catégorie</label>
          <input type="text" name="category" class="form-control" placeholder="Général">
        </div>
        <div class="col-12">
          <label class="form-label small fw-semibold">Contenu *</label>
          <textarea name="content" rows="5" class="form-control" required></textarea>
        </div>
        <div class="col-12 d-flex justify-content-end">
          <button class="btn btn-success"><i class="fas fa-save me-1"></i>Publier</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="card border-0 shadow-sm" style="border-radius:18px;">
  <div class="card-header bg-white border-0 pb-0 d-flex justify-content-between align-items-center">
    <h6 class="fw-bold text-success mb-0"><i class="fas fa-list me-1"></i> Articles</h6>
    <small class="text-muted"><span id="blog-count"><%= blogs.length %></span> total</small>
  </div>
  <div class="card-body p-0">
    <% if (blogs.length === 0) { %>
      <div class="text-center py-5 text-muted small">Aucun article pour le moment.</div>
    <% } else { %>
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th style="width:35%">Titre</th>
              <th>Catégorie</th>
              <th>Auteur</th>
              <th>Créé</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="blog-table-body">
            <% blogs.slice().sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt)).forEach(b => { %>
              <tr data-slug="<%= b.slug %>">
                <td class="small fw-semibold"><%= b.title %></td>
                <td class="small"><span class="badge bg-success-subtle text-success"><%= b.category %></span></td>
                <td class="small"><%= b.author %></td>
                <td class="small"><%= new Date(b.createdAt).toLocaleDateString('fr-FR') %></td>
                <td class="text-end">
                  <button class="btn btn-sm btn-outline-danger btn-delete-blog"><i class="fas fa-trash"></i></button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </div>
</div>

<script>
  // Création article
  document.getElementById('form-create-blog')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const form = e.target;
    const data = Object.fromEntries(new FormData(form).entries());
    try {
      const res = await fetch('/api/blogs', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data) });
      const json = await res.json();
      if(!json.success){ alert(json.message || 'Erreur'); return; }
      location.reload();
    } catch(err){ console.error(err); alert('Erreur réseau'); }
  });

  // Suppression
  document.querySelectorAll('.btn-delete-blog').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(!confirm('Supprimer cet article ?')) return;
      const tr = btn.closest('tr');
      const slug = tr.getAttribute('data-slug');
      try {
        const res = await fetch('/api/blogs/' + slug, { method:'DELETE' });
        const json = await res.json();
        if(json.success){
          tr.remove();
          const countEl = document.getElementById('blog-count');
          countEl.textContent = document.querySelectorAll('#blog-table-body tr').length;
        } else {
          alert(json.message || 'Erreur');
        }
      } catch(err){ console.error(err); alert('Erreur réseau'); }
    });
  });
</script>
<%- include('../layouts/dashboard-layout-end') %>